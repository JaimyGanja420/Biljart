<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Tryout Project</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>


		<script src="js/three.min.js"></script>
		<script src="js/Physics.js"></script>
		<script src="js/ball.js"></script>
        <script src="js/OrbitControls.js"></script>

		<script>

			//Scene setup
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.setClearColor(0x000000);
			document.body.appendChild(renderer.domElement);

			//Camera positioning
			camera.position.z = 20;
			camera.position.y = 20;

			//Orbit controls
			var controls = new THREE.OrbitControls(camera);
			controls.addEventListener('change');

			//Objects
            var loader = new THREE.ObjectLoader();
            loader.load('models/scene.json', function(tafel){
                scene.add(tafel);
            });

			var groundMaterial = new THREE.MeshPhongMaterial( { color: 0xffffff } );
			var ground = new THREE.Mesh( new THREE.PlaneBufferGeometry(100,100,2,2), groundMaterial);
			ground.position.y = -2;
			ground.rotation.x = - Math.PI / 2;
			scene.add(ground);

			scene.add( new THREE.AmbientLight(0x111111));

			var whiteBall = whiteSphere;
            whiteBall.position.y = 0.5;
			whiteBall.position.z = 5.875;
			whiteBall.position.x = 0;
			whiteBall.speedX = 0;
			whiteBall.speedZ = 0;
			scene.add(whiteBall);

            var redBall1 = redSphere;
            redBall1.position.y = 0.5;
            redBall1.position.x = 0;
			redBall1.position.z = -5.875;
			redBall1.speedX = 0;
			redBall1.speedZ = 0;
            scene.add(redBall1);



			var redBall2 = redBall1.clone();
			redBall2.position.y = 0.5;
			redBall2.position.x = -0.75;
			redBall2.position.z = -7.375;
			redBall2.speedX = 0;
			redBall2.speedZ = 0;
			scene.add(redBall2);

			var redBall3 = redBall2.clone();
			redBall3.position.y = 0.5;
			redBall3.position.x = 0.75;
			redBall3.position.z = -7.375;
			redBall3.speedX = 0;
			redBall3.speedZ = 0;
			scene.add(redBall3);

			var redBall4 = redBall3.clone();
			redBall4.position.y = 0.5;
			redBall4.position.x = -1.25;
			redBall4.position.z = -8.875;
			redBall4.speedX = 0;
			redBall4.speedZ = 0;
			scene.add(redBall4);

			var redBall5 = redBall4.clone();
			redBall5.position.y = 0.5;
			redBall5.position.x = 0;
			redBall5.position.z = -8.875;
			redBall5.speedX = 0;
			redBall5.speedZ = 0;
			scene.add(redBall5);

			var redBall6 = redBall5.clone();
			redBall6.position.y = 0.5;
			redBall6.position.x = 1.25;
			redBall6.position.z = -8.875;
			redBall6.speedX = 0;
			redBall6.speedZ = 0;
			scene.add(redBall6);


            //keu
            var isRemoved = false;
            var keuGeometry = new THREE.BoxGeometry(1,1,1);
            var keuMaterial = new THREE.MeshBasicMaterial( {color: 0xffff00 } );
            var keu = new THREE.Mesh( keuGeometry, keuMaterial );

            keu.position.x = whiteBall.position.x + 1;
            keu.position.y = 0.5;
            keu.position.z = whiteBall.position.z;
            scene.add(keu);

            //rotation variables
            const distance = 1;
            const speed = 0.03;
            var counter = 0;

            //key handlers
            var isRightPressed = false;
            var isLeftPressed = false;
            var isShoot = false;
            document.addEventListener("keydown", handleKeyDown, false);
            document.addEventListener("keyup", handleKeyUp, false);

            function handleKeyDown(e)
            {
                if(e.keyCode == 65)
                {
                    isRightPressed = true;
                } else if(e.keyCode == 68)
                {
                    isLeftPressed = true;
                }
                else if(e.keyCode == 86)
                {
                    isShoot = true;
                }
            }

            function handleKeyUp(e)
            {
                if(e.keyCode == 65)
                {
                    isRightPressed = false;
                } else if(e.keyCode == 68)
                {
                    isLeftPressed = false;
                }
            }

            //shoot function
            function shoot()
            {
                whiteBall.speedX = (keu.position.x - whiteBall.position.x) * -0.8;
                whiteBall.speedZ = (keu.position.z - whiteBall.position.z) * -0.8;
                isShoot = false;
            }

            //keu rotation function
            function rotateKeu()
            {
                if(whiteBall.speedX == 0 && whiteBall.speedZ == 0)
                {
                    if(isRemoved)
                    {
                        scene.add(keu);
                        keu.position.x = whiteBall.position.x + distance * Math.sin(counter);
                        keu.position.z = whiteBall.position.z + distance * Math.cos(counter);
                        isRemoved = false;
                    }
                    if(isRightPressed)
                    {
                        counter -= speed;
                        keu.position.x = whiteBall.position.x + distance * Math.sin(counter);
                        keu.position.z = whiteBall.position.z + distance * Math.cos(counter);
                    } else if(isLeftPressed)
                    {
                        counter += speed;
                        keu.position.x = whiteBall.position.x + distance * Math.sin(counter);
                        keu.position.z = whiteBall.position.z + distance * Math.cos(counter);
                    }
                }else
                {
                    if(!isRemoved)
                    {
                        scene.remove(keu);
                        isRemoved = true;
                    }
                }
            }



			var ballgroup = [whiteBall, redBall1, redBall2, redBall3, redBall4, redBall5, redBall6];

			var prev = redBall2;

			var isDone = false;
			function generateBalls()
			{
				for(var i = 3; i < 8; i++)
				{
					var clone = redBall1.clone();
					clone.position.x = prev.position.x + 1;
					clone.position.z = prev.position.z + 1;
					ballgroup[i] = clone;
					scene.add(clone);
					prev = clone;
				}
				isDone = true;
			}

			//Renderer
			function render() {
			    //Render init


				renderer.render(scene, camera);


				for(var index = 0; index < ballgroup.length; index++){
					slowDown(ballgroup[index]);
					collideWall(ballgroup[index]);
					for(var i = 0; i < ballgroup.length; i++){
						if(index != i)
							newCollide(ballgroup[index], ballgroup[i]);

					}
				}
				if(isShoot)
				{
					shoot();
				}
				rotateKeu();


				//Check if collision has happend
                //if (redBox.box.isIntersectionBox(whiteBox.box)) alert("They have hit!");
              /*  if (redBox.box.isIntersectionBox(whiteBox.box)){
                	alert(whiteBall.speedX);
                    tempx = whiteBall.speedX;
					whiteBall.speedX = redBall1.speedX;
					redBall1.speedX = tempx;

                    tempz = whiteBall.speedZ;
					whiteBall.speedZ = redBall1.speedZ;
					redBall1.speedZ = tempz;
                }*/

                //Ball speed vectors
				for(var i = 0; i < ballgroup.length; i++)
				{
					var ball = ballgroup[i];
					ball.position.x += ball.speedX;
					ball.position.z += ball.speedZ;
				}
/*
				//Playtable Border physics
                if(whiteBall.position.x >= 6.5 || whiteBall.position.x <= -6.5){
					whiteBall.speedX *= -1;
                }

				if(whiteBall.position.z >= 11.75 || whiteBall.position.z <= -11.75){
					whiteBall.speedZ *= -1;
				}

                if(redBall1.position.x >= 6.5 || redBall1.position.x <= -6.5){
					redBall1.speedX *= -1;
                }

                if(redBall1.position.z >= 11.75 || redBall1.position.z <= -11.75){
					redBall1.speedZ *= -1;
                }
				if(redBall2.position.x >= 6.5 || redBall2.position.x <= -6.5){
					redBall2.speedX *= -1;
				}

				if(redBall2.position.z >= 11.75 || redBall2.position.z <= -11.75){
					redBall2.speedZ *= -1;
				}

                //Slow down physics
                if(whiteBall.speedX > 0 || whiteBall.speedZ > 0){
					whiteBall.speedX *= 0.980;
					whiteBall.speedZ *= 0.980;
				}

				if(redBall1.speedX > 0 || redBall1.speedZ > 0){
					redBall1.speedX *= 0.980;
					redBall1.speedZ *= 0.980;
				}*/




				//Keep bounding boxes updated

                //redBox.update();
				requestAnimationFrame(render);

			}
			render();
		</script>
	</body>
</html>
